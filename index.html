<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unjumble Time</title>
  <link href="https://fonts.googleapis.com/css2?family=Nico+Moji&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Nico Moji', sans-serif;
      margin: 0;
      padding: 0;
      text-align: center;
      background: linear-gradient(to bottom, #fff1dd, #ffd18d);
      color: #333;
      transition: background-color 0.5s, color 0.5s;
    }
    body.dark {
      background: #1e1e2f;
      color: #ddd;
    }

    h1 {
      font-size: 2.5em;
      margin: 1rem;
      background: #f4a261;
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      display: inline-block;
      transition: background-color 0.5s;
    }
    body.dark h1 {
      background: #bb8453;
    }

    .grammar-button {
      font-size: 1.2rem;
      margin: 10px;
      padding: 12px 24px;
      cursor: pointer;
      border: none;
      border-radius: 12px;
      background: #f4a261;
      color: #2d2d2d;
      transition: background 0.3s, color 0.3s;
    }
    .grammar-button:hover {
      background: #e76f51;
      color: white;
    }
    body.dark .grammar-button {
      background: #bb8453;
      color: #eee;
    }
    body.dark .grammar-button:hover {
      background: #cc6f4a;
      color: #fff;
    }

    #nickname {
      margin: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 1rem;
      width: 200px;
      text-align: center;
      transition: background-color 0.5s, color 0.5s, border-color 0.5s;
    }
    body.dark #nickname {
      background: #33354a;
      color: #ddd;
      border-color: #666;
    }

    #leaderboard {
      width: 220px;
      margin: 0 auto 20px;
      background: #ffeccf;
      border-radius: 10px;
      padding: 10px;
      text-align: left;
      font-size: 0.9rem;
      transition: background-color 0.5s, color 0.5s;
    }
    body.dark #leaderboard {
      background: #2a2a3e;
      color: #ccc;
    }

    #leaderboard h3 {
      margin-top: 0;
      text-align: center;
    }

    #leaderboard-list {
      padding-left: 20px;
      margin: 0;
    }

    #grammar-select {
      margin-bottom: 20px;
    }

    #translation {
      font-size: 1.5rem;
      color: #555;
      margin: 10px 0;
      min-height: 2em;
      transition: color 0.5s;
    }
    body.dark #translation {
      color: #aaa;
    }

    #mission-tracker {
      margin: 10px 0;
      font-size: 1rem;
      color: #4b4b4b;
      min-height: 1.2em;
      transition: color 0.5s;
    }
    body.dark #mission-tracker {
      color: #bbb;
    }

    #word-bank,
    #drop-zone {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin: 20px auto;
      max-width: 700px;
      min-height: 50px;
    }

    .word {
      font-size: 2rem;
      padding: 12px 20px;
      cursor: grab;
      border-radius: 15px;
      background: #ffeccf;
      color: #333;
      box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
      user-select: none;
      transition: transform 0.2s ease, background-color 0.3s;
      min-width: max-content;
      user-select: none;
    }
    .word:active {
      transform: scale(1.05);
    }
    body.dark .word {
      background: #4a4a62;
      color: #ddd;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.4);
    }

    .word.correct {
      background-color: #c8e6c9 !important;
      color: #256029 !important;
    }
    body.dark .word.correct {
      background-color: #357a35 !important;
      color: #d0f5d0 !important;
    }

    .word.wrong {
      background-color: #f08080 !important;
      color: #fff !important;
    }
    body.dark .word.wrong {
      background-color: #a03a3a !important;
      color: #fff !important;
    }

    button {
      font-size: 1rem;
      margin: 10px 5px;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 10px;
      border: none;
      background-color: #f4a261;
      color: #2d2d2d;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #e76f51;
      color: white;
    }
    body.dark button {
      background-color: #bb8453;
      color: #eee;
    }
    body.dark button:hover {
      background-color: #cc6f4a;
      color: #fff;
    }

    #tick {
      font-size: 3rem;
      color: #2ecc71;
      display: none;
      animation: pop 0.5s ease-in-out;
      margin: 10px auto;
    }

    #score {
      font-size: 1.2rem;
      margin-top: 10px;
      color: #333;
      min-height: 1.4em;
      transition: color 0.5s;
    }
    body.dark #score {
      color: #ddd;
    }

    .word-slot {
      min-width: 100px;
      min-height: 40px;
      margin: 5px;
      border-bottom: 2px dashed #7a9ea3;
      padding: 5px;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: #fff1dd;
      transition: background-color 0.5s, border-color 0.5s;
    }
    body.dark .word-slot {
      background: #2c2c44;
      border-color: #5a6172;
    }

    @keyframes pop {
      0% {
        transform: scale(0);
        opacity: 0;
      }
      100% {
        transform: scale(1);
        opacity: 1;
      }
    }

    #custom-sentence-area {
      margin: 20px auto;
      max-width: 700px;
      text-align: left;
      background: #fff3d3;
      border-radius: 15px;
      padding: 15px;
      box-shadow: 0 3px 8px rgba(0,0,0,0.15);
      transition: background-color 0.5s;
    }
    body.dark #custom-sentence-area {
      background: #3b3b58;
      color: #ddd;
    }
    #custom-sentence-area label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    #custom-sentence-area input[type="text"],
    #custom-sentence-area select {
      width: 100%;
      padding: 8px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      transition: background-color 0.5s, color 0.5s, border-color 0.5s;
    }
    body.dark #custom-sentence-area input[type="text"],
    body.dark #custom-sentence-area select {
      background: #282a40;
      border-color: #666;
      color: #ddd;
    }
    #custom-sentence-area button {
      margin-top: 10px;
      width: 100%;
      font-weight: bold;
    }

    #theme-toggle {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 10px 15px;
      border-radius: 20px;
      background: #f4a261;
      color: #2d2d2d;
      cursor: pointer;
      border: none;
      font-weight: bold;
      z-index: 1000;
      transition: background-color 0.3s;
    }
    #theme-toggle:hover {
      background: #e76f51;
      color: white;
    }
    body.dark #theme-toggle {
      background: #bb8453;
      color: #eee;
    }
    body.dark #theme-toggle:hover {
      background: #cc6f4a;
      color: #fff;
    }
  </style>
</head>
<body>
  <button id="theme-toggle">Dark Mode</button>

  <h1>Unjumble Time</h1>

  <input id="nickname" placeholder="Enter your nickname" />

  <div id="leaderboard">
    <h3>Leaderboard</h3>
    <ol id="leaderboard-list"></ol>
  </div>

  <div id="grammar-select"></div>

  <div id="translation"></div>

  <div id="mission-tracker"></div>

  <div id="drop-zone"></div>
  <div id="word-bank"></div>

  <div id="tick">✔️</div>
  <div id="score">⭐ Score: 0</div>

  <button id="hint">💡 Hint</button>
  <button id="replay">🔊 Replay</button>
  <button id="next" style="display:none;">Next Sentence</button>

  <div id="custom-sentence-area">
    <h3>Add Custom Sentence</h3>
    <label for="custom-grammar">Choose Grammar Set:</label>
    <select id="custom-grammar"></select>
    <label for="custom-sentence">English Sentence:</label>
    <input id="custom-sentence" type="text" placeholder="Type your English sentence" />
    <label for="custom-translation">Japanese Translation:</label>
    <input id="custom-translation" type="text" placeholder="Type the Japanese translation" />
    <button id="add-sentence-btn">Add Sentence</button>
    <p id="add-sentence-msg" style="color:green;"></p>
  </div>

  <script>
    // Your original grammar sets with 5 sentences each:
    const baseGrammarSets = {
      "未来形": [
        { sentence: "I will play soccer tomorrow.", translation: "私は明日サッカーをします。" },
        { sentence: "She will visit her grandma.", translation: "彼女はおばあちゃんを訪ねます。" },
        { sentence: "They will eat dinner at 7.", translation: "彼らは7時に夕食を食べます。" },
        { sentence: "We will go to the park.", translation: "私たちは公園に行きます。" },
        { sentence: "He will study for the test.", translation: "彼はテストのために勉強します。" }
      ],
      "もし…": [
        { sentence: "If it rains, I will stay home.", translation: "もし雨が降ったら、家にいます。" },
        { sentence: "If you study, you will pass.", translation: "もし勉強すれば、合格します。" },
        { sentence: "If he calls, tell me.", translation: "もし彼が電話したら、教えて。" },
        { sentence: "If I have time, I will help.", translation: "もし時間があれば、手伝います。" },
        { sentence: "If she comes, we will start.", translation: "もし彼女が来たら、始めます。" }
      ],
      "するとき": [
        { sentence: "I listen to music when I study.", translation: "勉強するとき、音楽を聴きます。" },
        { sentence: "When it rains, I use an umbrella.", translation: "雨が降るとき、傘を使います。" },
        { sentence: "He eats breakfast when he wakes up.", translation: "起きるとき、彼は朝ごはんを食べます。" },
        { sentence: "When I go to school, I take the bus.", translation: "学校に行くとき、バスに乗ります。" },
        { sentence: "She calls me when she arrives.", translation: "着くとき、彼女は電話します。" }
      ],
      "…思う": [
        { sentence: "I think it will rain today.", translation: "今日は雨が降ると思います。" },
        { sentence: "She thinks the movie is fun.", translation: "彼女は映画が楽しいと思います。" },
        { sentence: "They think the test is easy.", translation: "彼らはテストが簡単だと思います。" },
        { sentence: "I think he is kind.", translation: "彼は優しいと思います。" },
        { sentence: "We think the food is delicious.", translation: "食べ物がおいしいと思います。" }
      ],
      "すること１": [
        { sentence: "I want to go to Japan.", translation: "日本に行きたいです。" },
        { sentence: "She wants to learn English.", translation: "彼女は英語を学びたいです。" },
        { sentence: "They want to watch a movie.", translation: "彼らは映画を見たいです。" },
        { sentence: "We want to play outside.", translation: "外で遊びたいです。" },
        { sentence: "He wants to read a book.", translation: "彼は本を読みたいです。" }
      ],
      "すること２": [
        { sentence: "I use plastic to save the environment.", translation: "環境を守るためにプラスチックを使います。" },
        { sentence: "She uses a bicycle every day.", translation: "彼女は毎日自転車を使います。" },
        { sentence: "They use computers for school.", translation: "彼らは学校でコンピューターを使います。" },
        { sentence: "We use energy carefully.", translation: "私たちはエネルギーを大切に使います。" },
        { sentence: "He uses a map to find the place.", translation: "彼は場所を探すために地図を使います。" }
      ],
      "しなければならない": [
        { sentence: "I must finish my homework.", translation: "宿題を終わらせなければなりません。" },
        { sentence: "She must clean her room.", translation: "彼女は部屋を掃除しなければなりません。" },
        { sentence: "They must arrive on time.", translation: "彼らは時間通りに着かなければなりません。" },
        { sentence: "We must study for the test.", translation: "テストのために勉強しなければなりません。" },
        { sentence: "He must wear a uniform.", translation: "彼は制服を着なければなりません。" }
      ],
      "してはいけない": [
        { sentence: "You must not run in the hall.", translation: "廊下で走ってはいけません。" },
        { sentence: "She must not eat during class.", translation: "授業中に食べてはいけません。" },
        { sentence: "They must not use phones here.", translation: "ここで携帯電話を使ってはいけません。" },
        { sentence: "We must not litter.", translation: "ゴミを捨ててはいけません。" },
        { sentence: "He must not be late.", translation: "彼は遅れてはいけません。" }
      ]
    };

    // We'll load sentences from localStorage or start from baseGrammarSets
    let grammarSets = JSON.parse(localStorage.getItem("customGrammarSets")) || baseGrammarSets;

    let currentSetName = null;
    let currentSet = [];
    let sentence = "";
    let words = [];
    let score = 0;

    const grammarSelect = document.getElementById("grammar-select");
    const dropZone = document.getElementById("drop-zone");
    const wordBank = document.getElementById("word-bank");
    const scoreDisplay = document.getElementById("score");
    const tick = document.getElementById("tick");
    const translationBox = document.getElementById("translation");
    const nextBtn = document.getElementById("next");
    const hintBtn = document.getElementById("hint");
    const replayBtn = document.getElementById("replay");
    const nicknameInput = document.getElementById("nickname");
    const leaderboardList = document.getElementById("leaderboard-list");
    const customGrammarSelect = document.getElementById("custom-grammar");
    const customSentenceInput = document.getElementById("custom-sentence");
    const customTranslationInput = document.getElementById("custom-translation");
    const addSentenceBtn = document.getElementById("add-sentence-btn");
    const addSentenceMsg = document.getElementById("add-sentence-msg");
    const themeToggle = document.getElementById("theme-toggle");
    const missionTracker = document.getElementById("mission-tracker");

    // Load nickname
    nicknameInput.value = localStorage.getItem("nickname") || "";

    // Dark mode state
    let isDark = localStorage.getItem("darkMode") === "true";
    if (isDark) {
      document.body.classList.add("dark");
      themeToggle.textContent = "Light Mode";
    } else {
      themeToggle.textContent = "Dark Mode";
    }

    function saveProgress() {
      const progress = {
        currentSetName,
        score,
        nickname: nicknameInput.value,
        grammarSets,
      };
      localStorage.setItem("unjumbleProgress", JSON.stringify(progress));
      localStorage.setItem("nickname", nicknameInput.value);
      localStorage.setItem("customGrammarSets", JSON.stringify(grammarSets));
    }

    function loadProgress() {
      const progressStr = localStorage.getItem("unjumbleProgress");
      if (!progressStr) return false;
      try {
        const progress = JSON.parse(progressStr);
        if (progress.currentSetName && grammarSets[progress.currentSetName]) {
          currentSetName = progress.currentSetName;
          currentSet = grammarSets[currentSetName];
          score = progress.score || 0;
          nicknameInput.value = progress.nickname || "";
          updateScore();
          updateMission();
          loadLeaderboard();
          showGrammarButtons(false);
          loadSentence();
          return true;
        }
      } catch (e) {
        console.warn("Failed to load progress", e);
      }
      return false;
    }

    // Build grammar buttons vertically in center
    function showGrammarButtons(show = true) {
      grammarSelect.innerHTML = "";
      if (!show) {
        grammarSelect.style.display = "none";
        return;
      }
      grammarSelect.style.display = "block";
      for (const key of Object.keys(grammarSets)) {
        const btn = document.createElement("button");
        btn.className = "grammar-button";
        btn.textContent = key;
        btn.onclick = () => {
          currentSetName = key;
          currentSet = grammarSets[key];
          score = 0;
          updateScore();
          updateMission();
          showGrammarButtons(false);
          saveProgress();
          loadSentence();
        };
        grammarSelect.appendChild(btn);
      }
    }

    // Load a sentence and set up the word bank and drop zone
    let currentSentenceIndex = 0;

    function loadSentence() {
      if (!currentSet || currentSet.length === 0) {
        alert("No sentences in this grammar set.");
        return;
      }
      if (currentSentenceIndex >= currentSet.length) {
        alert("You have finished all sentences in this set!");
        currentSentenceIndex = 0;
      }
      const data = currentSet[currentSentenceIndex];
      sentence = data.sentence;
      translationBox.textContent = data.translation;
      // Split words by space but keep punctuation attached (simple split)
      words = sentence.split(" ").map((w) => w.trim()).filter(Boolean);
      shuffle(words);

      dropZone.innerHTML = "";
      wordBank.innerHTML = "";

      // Create drop slots equal to sentence words
      for (let i = 0; i < words.length; i++) {
        const slot = document.createElement("div");
        slot.className = "word-slot";
        slot.dataset.index = i;
        slot.ondragover = allowDrop;
        slot.ondrop = drop;
        dropZone.appendChild(slot);
      }

      // Create draggable words
      words.forEach((word) => {
        const w = document.createElement("div");
        w.className = "word";
        w.textContent = word;
        w.draggable = true;
        w.ondragstart = drag;
        wordBank.appendChild(w);
      });

      nextBtn.style.display = "none";
      tick.style.display = "none";
      hintUsed = false;
      saveProgress();
    }

    // Shuffle helper
    function shuffle(arr) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
    }

    // Drag and drop handlers
    let draggedWord = null;

    function drag(ev) {
      draggedWord = ev.target;
      ev.dataTransfer.setData("text/plain", ev.target.textContent);
      ev.dataTransfer.effectAllowed = "move";
    }

    function allowDrop(ev) {
      ev.preventDefault();
    }

    function drop(ev) {
      ev.preventDefault();
      if (!draggedWord) return;
      const slot = ev.target;
      if (!slot.classList.contains("word-slot")) return;

      // Remove any word currently in slot
      if (slot.firstChild) {
        // Move the existing word back to wordBank
        wordBank.appendChild(slot.firstChild);
      }
      slot.appendChild(draggedWord);

      checkAnswer();
    }

    // Check answer correctness
    function checkAnswer() {
      const slots = [...dropZone.children];
      let correctCount = 0;
      let allFilled = true;

      slots.forEach((slot, i) => {
        const wordElem = slot.firstChild;
        if (!wordElem) {
          allFilled = false;
          return;
        }
        const expectedWord = words[i];
        if (wordElem.textContent === expectedWord) {
          wordElem.classList.remove("wrong");
          wordElem.classList.add("correct");
          correctCount++;
        } else {
          wordElem.classList.remove("correct");
          wordElem.classList.add("wrong");
        }
      });

      if (allFilled && correctCount === words.length) {
        onCorrectAnswer();
      }
    }

    function onCorrectAnswer() {
      tick.style.display = "block";
      score++;
      updateScore();
      updateMission();
      nextBtn.style.display = "inline-block";
      playAudio(sentence);
      saveLeaderboard();
      saveProgress();
    }

    function updateScore() {
      let stars = "⭐".repeat(score);
      scoreDisplay.textContent = `Score: ${stars}`;
    }

    function updateMission() {
      missionTracker.textContent = `Sentences completed: ${score}`;
    }

    // Hint system: reveal first word
    let hintUsed = false;
    hintBtn.onclick = () => {
      if (hintUsed) return;
      hintUsed = true;
      // Find first slot
      const firstSlot = dropZone.children[0];
      if (!firstSlot) return;
      // Move correct word to first slot from wordBank
      const correctWord = words[0];
      // Find the word in wordBank
      let foundWord = null;
      [...wordBank.children].forEach((w) => {
        if (w.textContent === correctWord) {
          foundWord = w;
        }
      });
      if (foundWord) {
        if (firstSlot.firstChild) {
          wordBank.appendChild(firstSlot.firstChild);
        }
        firstSlot.appendChild(foundWord);
        checkAnswer();
      }
    };

    // Replay audio
    replayBtn.onclick = () => {
      playAudio(sentence);
    };

    // Next sentence
    nextBtn.onclick = () => {
      currentSentenceIndex++;
      if (currentSentenceIndex >= currentSet.length) {
        currentSentenceIndex = 0;
        alert("You've completed all sentences in this set! Starting over.");
      }
      loadSentence();
      nextBtn.style.display = "none";
      tick.style.display = "none";
    };

    // Audio play function (Australian accent)
    function playAudio(text) {
      if (!window.speechSynthesis) return;
      const utter = new SpeechSynthesisUtterance(text);
      // Find an Australian English voice:
      const voices = window.speechSynthesis.getVoices();
      const ausVoice = voices.find(
        (v) => v.lang.startsWith("en") && v.name.toLowerCase().includes("australian")
      );
      if (ausVoice) utter.voice = ausVoice;
      utter.rate = 0.9;
      window.speechSynthesis.speak(utter);
    }

    // Leaderboard: store top 10 scores by nickname
    function loadLeaderboard() {
      const stored = localStorage.getItem("unjumbleLeaderboard");
      let leaderboard = stored ? JSON.parse(stored) : [];
      leaderboardList.innerHTML = "";
      leaderboard
        .sort((a, b) => b.score - a.score)
        .slice(0, 10)
        .forEach(({ name, score }) => {
          const li = document.createElement("li");
          li.textContent = `${name}: ${"⭐".repeat(score)}`;
          leaderboardList.appendChild(li);
        });
    }

    function saveLeaderboard() {
      const stored = localStorage.getItem("unjumbleLeaderboard");
      let leaderboard = stored ? JSON.parse(stored) : [];
      const name = nicknameInput.value.trim() || "Anonymous";
      const existingIndex = leaderboard.findIndex((p) => p.name === name);
      if (existingIndex >= 0) {
        if (leaderboard[existingIndex].score < score) {
          leaderboard[existingIndex].score = score;
        }
      } else {
        leaderboard.push({ name, score });
      }
      localStorage.setItem("unjumbleLeaderboard", JSON.stringify(leaderboard));
      loadLeaderboard();
    }

    // Custom sentence upload interface
    function populateCustomGrammarSelect() {
      customGrammarSelect.innerHTML = "";
      Object.keys(grammarSets).forEach((key) => {
        const option = document.createElement("option");
        option.value = key;
        option.textContent = key;
        customGrammarSelect.appendChild(option);
      });
    }

    addSentenceBtn.onclick = () => {
      const selectedGrammar = customGrammarSelect.value;
      const eng = customSentenceInput.value.trim();
      const jp = customTranslationInput.value.trim();
      if (!eng || !jp) {
        addSentenceMsg.style.color = "red";
        addSentenceMsg.textContent = "Please enter both English and Japanese sentences.";
        return;
      }
      if (!grammarSets[selectedGrammar]) {
        addSentenceMsg.style.color = "red";
        addSentenceMsg.textContent = "Invalid grammar set selected.";
        return;
      }
      grammarSets[selectedGrammar].push({ sentence: eng, translation: jp });
      addSentenceMsg.style.color = "green";
      addSentenceMsg.textContent = "Sentence added!";
      customSentenceInput.value = "";
      customTranslationInput.value = "";
      saveProgress();
      populateCustomGrammarSelect();
    };

    // Theme toggle
    themeToggle.onclick = () => {
      isDark = !isDark;
      if (isDark) {
        document.body.classList.add("dark");
        themeToggle.textContent = "Light Mode";
      } else {
        document.body.classList.remove("dark");
        themeToggle.textContent = "Dark Mode";
      }
      localStorage.setItem("darkMode", isDark);
    };

    // Initialize app
    function init() {
      populateCustomGrammarSelect();
      loadLeaderboard();
      if (!loadProgress()) {
        showGrammarButtons(true);
      }
      nicknameInput.oninput = () => {
        localStorage.setItem("nickname", nicknameInput.value.trim());
        saveLeaderboard();
      };
    }

    init();
  </script>
</body>
</html>
