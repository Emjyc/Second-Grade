<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Unjumble the Sentence</title>
<link href="https://fonts.googleapis.com/css2?family=Nico+Moji&display=swap" rel="stylesheet" />
<style>
  body {
    font-family: 'Nico Moji', sans-serif;
    background: linear-gradient(to bottom, #ffe3e3, #f5f5dc);
    margin: 0; padding: 0;
    color: #333;
    transition: background-color 0.3s, color 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
  }
  body.dark {
    background: linear-gradient(to bottom, #2c3e50, #34495e);
    color: #ddd;
  }
  #themeToggle {
    position: fixed;
    top: 10px; right: 10px; z-index: 1000;
    cursor: pointer;
    border-radius: 10px;
    border: none;
    background-color: #ffdac1;
    padding: 8px 12px;
    font-size: 1rem;
    transition: background-color 0.3s;
  }
  body.dark #themeToggle {
    background-color: #bb8fce;
    color: #f7f1ff;
  }
  #start-screen {
    display: flex;
    width: 100%;
    max-width: 900px;
    padding: 20px;
    box-sizing: border-box;
  }
  #start-left {
    width: 280px;
    display: flex;
    flex-direction: column;
    gap: 20px;
  }
  #nickname-container {
    display: flex;
    flex-direction: column;
  }
  #nickname-container label {
    font-weight: bold;
    margin-bottom: 5px;
  }
  #nickname {
    padding: 8px 12px;
    border-radius: 15px;
    border: 2px solid #a2d2ff;
    font-size: 1.1rem;
    outline: none;
    transition: border-color 0.3s;
  }
  #nickname:focus {
    border-color: #6c7ae0;
  }
  #leaderboard {
    background: #fef9f1;
    border-radius: 15px;
    padding: 10px 15px;
    max-height: 280px;
    overflow-y: auto;
    box-shadow: 2px 2px 10px rgba(0,0,0,0.1);
  }
  body.dark #leaderboard {
    background: #6e5494;
    color: #eee;
    box-shadow: none;
  }
  #leaderboard h3 {
    margin: 0 0 10px 0;
    font-size: 1.2rem;
    text-align: center;
  }
  #leaderboard ol {
    padding-left: 20px;
    margin: 0;
  }
  #leaderboard li {
    margin: 4px 0;
    font-size: 1.1rem;
    letter-spacing: 1px;
  }

  #start-right {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #start-right h1 {
    font-size: 3rem;
    margin-bottom: 25px;
    background: #ffd6ec;
    padding: 10px 20px;
    border-radius: 30px;
    width: 100%;
    max-width: 500px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(255, 150, 200, 0.6);
    user-select: none;
  }
  body.dark #start-right h1 {
    background: #8e44ad;
    color: #f0e5f9;
    box-shadow: 0 4px 12px rgba(150, 100, 255, 0.8);
  }
  .grammar-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
    width: 100%;
    max-width: 320px;
  }
  .grammar-button {
    font-size: 1.4rem;
    padding: 14px 0;
    border-radius: 20px;
    border: none;
    cursor: pointer;
    background: #a2d2ff;
    transition: background-color 0.3s, transform 0.2s;
    box-shadow: 0 4px 8px #82b1ff;
    user-select: none;
  }
  .grammar-button:hover, .grammar-button:focus {
    background: #6c7ae0;
    color: #fff;
    transform: translateY(-4px);
    outline: none;
  }
  body.dark .grammar-button {
    background: #6c7ae0;
    box-shadow: 0 4px 8px #4a4fbc;
    color: #f0e5f9;
  }
  body.dark .grammar-button:hover {
    background: #a2d2ff;
    color: #222;
  }

  /* GAME SCREEN */

  #game-screen {
    display: none;
    width: 100%;
    max-width: 900px;
    padding: 20px;
    box-sizing: border-box;
    flex-direction: column;
    align-items: center;
    text-align: center;
  }
  #game-screen.active {
    display: flex;
  }
  #game-title {
    font-size: 2.7rem;
    margin-bottom: 10px;
    background: #ffd6ec;
    padding: 10px 25px;
    border-radius: 30px;
    user-select: none;
    box-shadow: 0 4px 10px rgba(255,150,200,0.7);
  }
  body.dark #game-title {
    background: #8e44ad;
    color: #f0e5f9;
    box-shadow: 0 4px 12px rgba(150,100,255,0.8);
  }
  #translation {
    font-size: 1.5rem;
    color: #555;
    margin-bottom: 15px;
    user-select: none;
  }
  body.dark #translation {
    color: #ccc;
  }
  #progress-container {
    width: 80%;
    max-width: 500px;
    height: 20px;
    background: #ddd;
    border-radius: 15px;
    margin-bottom: 25px;
    overflow: hidden;
  }
  body.dark #progress-container {
    background: #555;
  }
  #progress-bar {
    height: 100%;
    background: #a2d2ff;
    width: 0%;
    transition: width 0.5s ease;
  }
  body.dark #progress-bar {
    background: #6c7ae0;
  }

  #drop-zone {
    display: flex;
    justify-content: center;
    flex-wrap: nowrap;
    gap: 10px;
    margin-bottom: 20px;
    min-height: 60px;
  }
  .word-slot {
    flex: 1 1 0;
    min-width: 80px;
    border-bottom: 3px dashed #ccc;
    border-radius: 15px;
    padding: 6px 8px;
    box-sizing: border-box;
    user-select: none;
    transition: border-color 0.3s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  body.dark .word-slot {
    border-color: #999;
  }

  #word-bank {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 15px;
    margin-bottom: 25px;
  }
  .word {
    background: #fff8dc;
    padding: 10px 18px;
    border-radius: 18px;
    font-size: 2rem;
    cursor: grab;
    user-select: none;
    box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
    transition: background-color 0.3s, color 0.3s;
  }
  body.dark .word {
    background: #7f8c8d;
    color: #eee;
    box-shadow: none;
  }
  .word.correct {
    background-color: #d4edda;
    color: green;
  }
  .word.wrong {
    background-color: #f8d7da;
    color: red;
  }
  .word:active {
    transform: scale(1.1);
  }

  button {
    font-size: 1rem;
    padding: 10px 20px;
    margin: 5px 10px;
    border-radius: 15px;
    border: none;
    cursor: pointer;
    background-color: #ffdac1;
    box-shadow: 0 4px 8px #ffb681;
    transition: background-color 0.3s, transform 0.2s;
    user-select: none;
  }
  button:hover, button:focus {
    background-color: #ffb681;
    transform: translateY(-4px);
    outline: none;
  }
  body.dark button {
    background-color: #bb8fce;
    color: #f7f1ff;
    box-shadow: 0 4px 8px #9d7acc;
  }
  body.dark button:hover {
    background-color: #a07ed1;
    color: #fff;
  }

  #hintBtn {
    animation: glowPulse 2s infinite;
  }

  #tick {
    font-size: 3rem;
    color: green;
    opacity: 0;
    transition: opacity 0.5s ease;
    user-select: none;
  }
  #tick.show {
    opacity: 1;
  }

  #score {
    font-size: 2.3rem;
    letter-spacing: 6px;
    margin-bottom: 20px;
    min-height: 2.8rem;
    display: flex;
    justify-content: center;
    gap: 6px;
  }
  .star {
    position: relative;
    display: inline-block;
    font-size: 1.8rem;
    cursor: default;
  }
  .star.popburst {
    animation: popBurstScale 0.5s ease forwards;
  }
  .star.popburst::before {
    content: "";
    position: absolute;
    top: 50%;
    left: 50%;
    width: 1.6em;
    height: 1.6em;
    background: radial-gradient(circle, #ffd700 40%, transparent 70%);
    border-radius: 50%;
    transform: translate(-50%, -50%) scale(0);
    animation: burst 0.5s ease forwards;
    z-index: -1;
  }

  #mission-tracker {
    font-size: 1.1rem;
    margin-bottom: 25px;
    user-select: none;
  }

  /* Pop & Color Burst Animation for stars */
  @keyframes popBurstScale {
    0% {
      transform: scale(0);
      opacity: 0;
    }
    60% {
      transform: scale(1.4);
      opacity: 1;
    }
    100% {
      transform: scale(1);
    }
  }
  @keyframes burst {
    0% {
      opacity: 0.6;
      transform: scale(0);
    }
    70% {
      opacity: 0;
      transform: scale(1.6);
    }
    100% {
      opacity: 0;
      transform: scale(1.6);
    }
  }

  /* Glow pulse for hint button */
  @keyframes glowPulse {
    0%, 100% { box-shadow: 0 0 6px 2px #ffdd55; }
    50% { box-shadow: 0 0 14px 6px #fff066; }
  }

  /* Confetti container */
  #confetti-container {
    pointer-events: none;
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    overflow: visible;
    z-index: 1000;
  }
  .confetti {
    position: absolute;
    width: 8px;
    height: 8px;
    background-color: #ffda44;
    opacity: 0.9;
    border-radius: 2px;
    animation-name: confetti-fall;
    animation-timing-function: linear;
  }
  @keyframes confetti-fall {
    0% {
      transform: translateY(0) rotate(0deg);
      opacity: 1;
    }
    100% {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }

</style>
</head>
<body>
<button id="themeToggle">üåô Dark Mode</button>

<div id="start-screen" class="active">
  <div id="start-left">
    <div id="nickname-container">
      <label for="nickname">Your Nickname</label>
      <input type="text" id="nickname" maxlength="15" placeholder="Enter nickname" autocomplete="off" />
      <button id="clearProgressBtn" style="margin-top:10px;">Clear Progress</button>
    </div>

    <div id="leaderboard">
      <h3>Leaderboard - Top 10 ‚≠ê</h3>
      <ol id="leaderboard-list"></ol>
    </div>
  </div>

  <div id="start-right">
    <h1>ÊñáÊ≥ï„ÇíÈÅ∏„Åº„ÅÜ</h1>
    <div class="grammar-list">
      <button class="grammar-button" data-set="future">Êú™Êù•ÂΩ¢ üöÄ</button>
      <button class="grammar-button" data-set="if">„ÇÇ„Åó‚Ä¶ ‚òÅÔ∏è</button>
      <button class="grammar-button" data-set="when">„Äú„Åô„Çã„Å®„Åç ‚è∞</button>
      <button class="grammar-button" data-set="think">‚Ä¶„Å®ÊÄù„ÅÜ üí≠</button>
      <button class="grammar-button" data-set="want">„Åô„Çã„Åì„Å®Ôºë üíñ</button>
      <button class="grammar-button" data-set="purpose">„Åô„Çã„Åì„Å®Ôºí üå±</button>
      <button class="grammar-button" data-set="must">„Åó„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ üîí</button>
      <button class="grammar-button" data-set="mustNot">„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ üö´</button>
    </div>
  </div>
</div>

<div id="game-screen">
  <h1 id="game-title"></h1>
  <div id="translation"></div>

  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>

  <div id="drop-zone"></div>
  <div id="word-bank"></div>
  <button id="hintBtn" onclick="showHint()">üí° Hint</button>
  <button onclick="replayAudio()">üîä Replay</button>
  <button id="nextBtn" onclick="nextSentence()" style="opacity:0; transition: opacity 0.4s;">‚û°Ô∏è Next</button>
  <div id="tick">‚úîÔ∏è</div>
  <div id="score"></div>
  <div id="mission-tracker"></div>
</div>

<div id="confetti-container"></div>

<script>
  // SENTENCE SETS with 5 sentences each
  const sentenceSets = {
    future: [
      { en: "I will play soccer tomorrow", jp: "ÁßÅ„ÅØÊòéÊó•„Çµ„ÉÉ„Ç´„Éº„Çí„Åó„Åæ„Åô" },
      { en: "She will visit her grandmother next week", jp: "ÂΩºÂ•≥„ÅØÊù•ÈÄ±„Åä„Å∞„ÅÇ„Åï„Çì„ÇíË®™„Çå„Åæ„Åô" },
      { en: "They will have lunch at noon", jp: "ÂΩº„Çâ„ÅØÊ≠£Âçà„Å´Êòº„Åî„ÅØ„Çì„ÇíÈ£ü„Åπ„Åæ„Åô" },
      { en: "We will watch a movie tonight", jp: "ÁßÅ„Åü„Å°„ÅØ‰ªäÊô©Êò†Áîª„ÇíË¶ã„Åæ„Åô" },
      { en: "He will study English tomorrow", jp: "ÂΩº„ÅØÊòéÊó•Ëã±Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô" }
    ],
    if: [
      { en: "If it rains, I will stay home", jp: "„ÇÇ„ÅóÈõ®„ÅåÈôç„Å£„Åü„Çâ„ÄÅÂÆ∂„Å´„ÅÑ„Åæ„Åô" },
      { en: "If I study, I will pass the test", jp: "„ÇÇ„ÅóÂãâÂº∑„Åô„Çå„Å∞„ÄÅ„ÉÜ„Çπ„Éà„Å´ÂêàÊ†º„Åó„Åæ„Åô" },
      { en: "If she calls, tell me", jp: "„ÇÇ„ÅóÂΩºÂ•≥„ÅåÈõªË©±„Åó„Åü„Çâ„ÄÅÊïô„Åà„Å¶„Åè„Å†„Åï„ÅÑ" },
      { en: "If we hurry, we won't be late", jp: "„ÇÇ„ÅóÊÄ•„Åí„Å∞„ÄÅÈÅÖ„Çå„Åæ„Åõ„Çì" },
      { en: "If you eat too much, you get sick", jp: "„ÇÇ„ÅóÈ£ü„ÅπÈÅé„Åé„Çã„Å®„ÄÅÁóÖÊ∞ó„Å´„Å™„Çä„Åæ„Åô" }
    ],
    when: [
      { en: "I wash my hands when I get home", jp: "ÂÆ∂„Å´Â∏∞„Çã„Å®„Åç„ÄÅÊâã„ÇíÊ¥ó„ÅÑ„Åæ„Åô" },
      { en: "When it is sunny, we play outside", jp: "Êô¥„Çå„ÅÆ„Å®„Åç„ÄÅÂ§ñ„ÅßÈÅä„Å≥„Åæ„Åô" },
      { en: "He reads a book when he waits", jp: "ÂæÖ„Å£„Å¶„ÅÑ„Çã„Å®„Åç„ÄÅÊú¨„ÇíË™≠„Åø„Åæ„Åô" },
      { en: "When school starts, I get nervous", jp: "Â≠¶Ê†°„ÅåÂßã„Åæ„Çã„Å®„Åç„ÄÅÁ∑äÂºµ„Åó„Åæ„Åô" },
      { en: "When I eat, I watch TV", jp: "È£ü„Åπ„Çã„Å®„Åç„ÄÅ„ÉÜ„É¨„Éì„ÇíË¶ã„Åæ„Åô" }
    ],
    think: [
      { en: "I think it will rain tomorrow", jp: "ÊòéÊó•„ÅØÈõ®„ÅåÈôç„Çã„Å®ÊÄù„ÅÑ„Åæ„Åô" },
      { en: "She thinks the test is hard", jp: "ÂΩºÂ•≥„ÅØ„ÉÜ„Çπ„Éà„ÅåÈõ£„Åó„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô" },
      { en: "They think this movie is fun", jp: "ÂΩº„Çâ„ÅØ„Åì„ÅÆÊò†Áîª„ÅØÊ•Ω„Åó„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô" },
      { en: "I think we should study more", jp: "„ÇÇ„Å£„Å®ÂãâÂº∑„Åô„Çã„Åπ„Åç„Å†„Å®ÊÄù„ÅÑ„Åæ„Åô" },
      { en: "He thinks Japanese is interesting", jp: "ÂΩº„ÅØÊó•Êú¨Ë™û„ÅØÈù¢ÁôΩ„ÅÑ„Å®ÊÄù„ÅÑ„Åæ„Åô" }
    ],
    want: [
      { en: "I want to go to Japan", jp: "Êó•Êú¨„Å´Ë°å„Åç„Åü„ÅÑ„Åß„Åô" },
      { en: "She wants to eat sushi", jp: "ÂΩºÂ•≥„ÅØÂØøÂè∏„ÇíÈ£ü„Åπ„Åü„ÅÑ„Åß„Åô" },
      { en: "They want to watch anime", jp: "ÂΩº„Çâ„ÅØ„Ç¢„Éã„É°„ÇíË¶ã„Åü„ÅÑ„Åß„Åô" },
      { en: "I want to read a book", jp: "Êú¨„ÇíË™≠„Åø„Åü„ÅÑ„Åß„Åô" },
      { en: "He wants to play tennis", jp: "ÂΩº„ÅØ„ÉÜ„Éã„Çπ„Çí„Åó„Åü„ÅÑ„Åß„Åô" }
    ],
    purpose: [
      { en: "I use plastic to save the environment", jp: "Áí∞Â¢É„ÇíÂÆà„Çã„Åü„ÇÅ„Å´„Éó„É©„Çπ„ÉÅ„ÉÉ„ÇØ„Çí‰Ωø„ÅÑ„Åæ„Åô" },
      { en: "She studies Japanese to speak well", jp: "ÂΩºÂ•≥„ÅØ‰∏äÊâã„Å´Ë©±„Åô„Åü„ÇÅ„Å´Êó•Êú¨Ë™û„ÇíÂãâÂº∑„Åó„Åæ„Åô" },
      { en: "We recycle to help the planet", jp: "Âú∞ÁêÉ„ÇíÂä©„Åë„Çã„Åü„ÇÅ„Å´„É™„Çµ„Ç§„ÇØ„É´„Åó„Åæ„Åô" },
      { en: "He exercises to stay healthy", jp: "ÂÅ•Â∫∑„Çí‰øù„Å§„Åü„ÇÅ„Å´ÈÅãÂãï„Åó„Åæ„Åô" },
      { en: "They plant trees to clean the air", jp: "Á©∫Ê∞ó„Çí„Åç„Çå„ÅÑ„Å´„Åô„Çã„Åü„ÇÅ„Å´Êú®„ÇíÊ§ç„Åà„Åæ„Åô" }
    ],
    must: [
      { en: "You must finish your homework", jp: "ÂÆøÈ°å„ÇíÁµÇ„Çè„Çâ„Åõ„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì" },
      { en: "We must wear masks", jp: "„Éû„Çπ„ÇØ„Çí„Åó„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì" },
      { en: "He must not be late", jp: "ÂΩº„ÅØÈÅÖ„Çå„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì" },
      { en: "You must listen carefully", jp: "Ê≥®ÊÑèÊ∑±„ÅèËÅû„Åã„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì" },
      { en: "She must study every day", jp: "ÂΩºÂ•≥„ÅØÊØéÊó•ÂãâÂº∑„Åó„Å™„Åë„Çå„Å∞„Å™„Çä„Åæ„Åõ„Çì" }
    ],
    mustNot: [
      { en: "You must not smoke here", jp: "„Åì„Åì„Åß„Åü„Å∞„Åì„ÇíÂê∏„Å£„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì" },
      { en: "They must not enter", jp: "ÂΩº„Çâ„ÅØÂÖ•„Å£„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì" },
      { en: "He must not speak loudly", jp: "ÂΩº„ÅØÂ§ßÂ£∞„ÅßË©±„Åó„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì" },
      { en: "You must not use your phone", jp: "Êê∫Â∏ØÈõªË©±„Çí‰Ωø„Å£„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì" },
      { en: "She must not eat sweets", jp: "ÂΩºÂ•≥„ÅØ„ÅäËèìÂ≠ê„ÇíÈ£ü„Åπ„Å¶„ÅØ„ÅÑ„Åë„Åæ„Åõ„Çì" }
    ]
  };

  // GAME STATE
  let currentSet = [];
  let sentence = "";
  let words = [];
  let shuffledWords = [];
  let score = 0;
  let streak = 0;
  let streakAnimationTimeout;
  let userName = "";
  const streakMilestones = [3,5,10];

  // DOM ELEMENTS
  const startScreen = document.getElementById('start-screen');
  const gameScreen = document.getElementById('game-screen');
  const gameTitle = document.getElementById('game-title');
  const translationEl = document.getElementById('translation');
  const dropZone = document.getElementById('drop-zone');
  const wordBank = document.getElementById('word-bank');
  const tick = document.getElementById('tick');
  const scoreEl = document.getElementById('score');
  const missionTracker = document.getElementById('mission-tracker');
  const nextBtn = document.getElementById('nextBtn');
  const hintBtn = document.getElementById('hintBtn');
  const nicknameInput = document.getElementById('nickname');
  const leaderboardList = document.getElementById('leaderboard-list');
  const clearProgressBtn = document.getElementById('clearProgressBtn');
  const progressBar = document.getElementById('progress-bar');
  const themeToggle = document.getElementById('themeToggle');
  const confettiContainer = document.getElementById('confetti-container');

  // Save/load from localStorage keys
  function storageKey(name) {
    return `unjumble-progress-${name}`;
  }
  function storageLeaderboardKey() {
    return 'unjumble-leaderboard';
  }

  // THEME TOGGLE
  themeToggle.addEventListener('click', () => {
    document.body.classList.toggle('dark');
    themeToggle.textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
  });

  // LOAD LEADERBOARD
  function loadLeaderboard() {
    let data = JSON.parse(localStorage.getItem(storageLeaderboardKey())) || {};
    // Sort descending by stars
    let entries = Object.entries(data);
    entries.sort((a,b) => b[1].stars - a[1].stars);
    leaderboardList.innerHTML = "";
    entries.slice(0,10).forEach(([name, {stars}]) => {
      let li = document.createElement('li');
      li.textContent = `${name}: ${stars} ‚≠ê`;
      leaderboardList.appendChild(li);
    });
  }

  // SAVE TO LEADERBOARD
  function saveToLeaderboard(name, stars, streak) {
    if (!name) return;
    let data = JSON.parse(localStorage.getItem(storageLeaderboardKey())) || {};
    if (!data[name] || data[name].stars < stars) {
      data[name] = { stars, streak };
      localStorage.setItem(storageLeaderboardKey(), JSON.stringify(data));
    }
    loadLeaderboard();
  }

  // CLEAR PROGRESS
  clearProgressBtn.addEventListener('click', () => {
    if (!userName) {
      alert("Please enter your nickname first.");
      return;
    }
    if (confirm(`Clear progress for ${userName}? This cannot be undone.`)) {
      localStorage.removeItem(storageKey(userName));
      // Also reset leaderboard entry for this user
      let data = JSON.parse(localStorage.getItem(storageLeaderboardKey())) || {};
      delete data[userName];
      localStorage.setItem(storageLeaderboardKey(), JSON.stringify(data));
      score = 0; streak = 0;
      updateScoreDisplay();
      loadLeaderboard();
      alert("Progress cleared.");
    }
  });

  // START GAME
  function startGame(setName) {
    userName = nicknameInput.value.trim();
    if (!userName) {
      alert("Please enter a nickname before starting.");
      return;
    }
    // Save progress for user if exists
    const saved = JSON.parse(localStorage.getItem(storageKey(userName)));
    if (saved && saved.setName === setName) {
      score = saved.score || 0;
      streak = saved.streak || 0;
      updateScoreDisplay();
      missionTracker.textContent = `Current streak: ${streak}`;
    } else {
      score = 0;
      streak = 0;
      updateScoreDisplay();
      missionTracker.textContent = "";
    }

    currentSet = sentenceSets[setName];
    sentence = "";
    words = [];
    shuffledWords = [];
    gameTitle.textContent = {
      future: "Êú™Êù•ÂΩ¢ üöÄ",
      if: "„ÇÇ„Åó‚Ä¶ ‚òÅÔ∏è",
      when: "„Äú„Åô„Çã„Å®„Åç ‚è∞",
      think: "‚Ä¶„Å®ÊÄù„ÅÜ üí≠",
      want: "„Åô„Çã„Åì„Å®Ôºë üíñ",
      purpose: "„Åô„Çã„Åì„Å®Ôºí üå±",
      must: "„Åó„Å™„Åë„Çå„Å∞„Å™„Çâ„Å™„ÅÑ üîí",
      mustNot: "„Åó„Å¶„ÅØ„ÅÑ„Åë„Å™„ÅÑ üö´"
    }[setName] || setName;

    startScreen.classList.remove('active');
    gameScreen.classList.add('active');
    nextSentence();
  }

  // UPDATE SCORE DISPLAY (stars bar)
  function updateScoreDisplay() {
    scoreEl.innerHTML = "";
    for(let i=0; i < score; i++) {
      const star = document.createElement("span");
      star.classList.add("star");
      star.textContent = "‚≠ê";
      scoreEl.appendChild(star);
    }
  }

  // NEXT SENTENCE
  function nextSentence() {
    // Hide next button initially & tick
    nextBtn.style.opacity = 0;
    tick.classList.remove('show');
    missionTracker.textContent = `Current streak: ${streak}`;

    // Pick random sentence from currentSet
    const entry = currentSet[Math.floor(Math.random() * currentSet.length)];
    sentence = entry.en;
    words = sentence.split(" ");
    shuffledWords = shuffleArray([...words]);

    // Clear UI
    dropZone.innerHTML = "";
    wordBank.innerHTML = "";
    translationEl.textContent = entry.jp;

    // Create slots in drop zone (snap targets)
    for (let i=0; i<words.length; i++) {
      const slot = document.createElement('div');
      slot.classList.add('word-slot');
      slot.dataset.index = i;
      dropZone.appendChild(slot);
    }

    // Create draggable words
    shuffledWords.forEach(word => {
      const el = document.createElement("div");
      el.textContent = word;
      el.classList.add("word");
      el.draggable = true;
      el.addEventListener("dragstart", dragStart);
      wordBank.appendChild(el);
    });

    updateProgressBar();
  }

  // DRAG & DROP HANDLERS
  let draggedWord = null;
  function dragStart(e) {
    draggedWord = e.target;
    e.dataTransfer.setData("text/plain", e.target.textContent);
    // Needed for Firefox
    e.dataTransfer.effectAllowed = "move";
  }
  function allowDrop(e) {
    e.preventDefault();
  }
  function drop(e) {
    e.preventDefault();
    if (!draggedWord) return;
    if (e.target.classList.contains("word-slot")) {
      // If slot already has a word, return it to wordBank first
      if (e.target.firstChild) {
        wordBank.appendChild(e.target.firstChild);
      }
      e.target.appendChild(draggedWord);
      checkAnswer();
    }
  }

  dropZone.addEventListener("dragover", allowDrop);
  dropZone.addEventListener("drop", drop);

  // CHECK ANSWER
  function checkAnswer() {
    const arrangedWords = [];
    // Gather words in slots by index order
    const slots = [...dropZone.children];
    for(let slot of slots) {
      arrangedWords.push(slot.firstChild ? slot.firstChild.textContent : "");
    }
    // Color code correct/wrong words
    slots.forEach((slot, i) => {
      if (!slot.firstChild) {
        slot.style.borderColor = "#ccc";
        return;
      }
      if (slot.firstChild.textContent === words[i]) {
        slot.style.borderColor = "#28a745"; // green
      } else {
        slot.style.borderColor = "#dc3545"; // red
      }
    });

    // Check full sentence
    if (arrangedWords.join(" ") === sentence) {
      tick.classList.add('show');
      nextBtn.style.opacity = 1;
      addStar();
      streak++;
      missionTracker.textContent = `Current streak: ${streak}`;
      saveProgress();
      showStreakBonusIfNeeded();
      playConfetti();
      speakSentence();
    } else {
      tick.classList.remove('show');
      nextBtn.style.opacity = 0;
      streak = 0;
      missionTracker.textContent = `Current streak: ${streak}`;
      saveProgress();
    }
  }

  // SHOW HINT - first word snap
  function showHint() {
    // Check if first slot empty, fill with first word from original sentence if present in wordBank
    const firstSlot = dropZone.children[0];
    if (firstSlot && !firstSlot.firstChild) {
      const hintWord = words[0];
      const candidate = [...wordBank.children].find(el => el.textContent === hintWord);
      if (candidate) {
        firstSlot.appendChild(candidate);
        checkAnswer();
      }
    }
  }

  // REPLAY AUDIO
  function speakSentence() {
    if (!window.speechSynthesis) return;
    const utterance = new SpeechSynthesisUtterance(sentence);
    const voices = speechSynthesis.getVoices();
    const aussieVoice = voices.find(v => v.lang === "en-AU") || voices.find(v => v.lang.startsWith("en"));
    if (aussieVoice) utterance.voice = aussieVoice;
    speechSynthesis.cancel();
    speechSynthesis.speak(utterance);
  }
  function replayAudio() {
    const arrangedWords = Array.from(dropZone.children).map(slot => slot.firstChild?.textContent || "").join(" ");
    if (arrangedWords === sentence) speakSentence();
  }

  // SAVE PROGRESS to localStorage by nickname
  function saveProgress() {
    if (!userName) return;
    const data = {
      setName: gameTitle.textContent,
      score,
      streak,
    };
    localStorage.setItem(storageKey(userName), JSON.stringify(data));
    saveToLeaderboard(userName, score, streak);
  }

  // ADD STAR (visual & score)
  function addStar() {
    score++;
    updateScoreDisplay();
    animateLatestStar();
    updateProgressBar();
  }
  function updateProgressBar() {
    const total = currentSet.length;
    const percent = Math.min(100, (score / total) * 100);
    progressBar.style.width = percent + "%";
  }

  // Animate the latest star with pop & burst
  function animateLatestStar() {
    const stars = scoreEl.querySelectorAll(".star");
    if (stars.length === 0) return;
    const latestStar = stars[stars.length -1];
    latestStar.classList.add("popburst");
    setTimeout(() => {
      latestStar.classList.remove("popburst");
    }, 500);
  }

  // Show streak bonus star sparkle if milestone hit
  function showStreakBonusIfNeeded() {
    if (streakMilestones.includes(streak)) {
      const star = document.createElement("span");
      star.textContent = "üåü";
      star.style.position = "fixed";
      star.style.top = "70px";
      star.style.right = "20px";
      star.style.fontSize = "3rem";
      star.style.opacity = "1";
      star.style.transition = "opacity 1.2s ease";
      document.body.appendChild(star);
      setTimeout(() => {
        star.style.opacity = "0";
        setTimeout(() => {
          document.body.removeChild(star);
        }, 1200);
      }, 800);
      // Bonus stars
      for(let i=0; i<2; i++) addStar();
    }
  }

  // Confetti animation for celebration
  function playConfetti() {
    const confettiCount = 30;
    for(let i=0; i < confettiCount; i++) {
      const confetti = document.createElement("div");
      confetti.classList.add("confetti");
      confetti.style.left = Math.random() * window.innerWidth + "px";
      confetti.style.top = "-10px";
      confetti.style.backgroundColor = `hsl(${Math.random() * 360}, 100%, 70%)`;
      confetti.style.animationDuration = (2 + Math.random()*2) + "s";
      confetti.style.transform = `rotate(${Math.random()*360}deg)`;
      confettiContainer.appendChild(confetti);
      setTimeout(() => {
        confetti.remove();
      }, 4000);
    }
  }

  // SHUFFLE ARRAY
  function shuffleArray(arr) {
    let a = arr.slice();
    for(let i = a.length -1; i > 0; i--) {
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // EVENT LISTENERS FOR START SCREEN BUTTONS
  document.querySelectorAll(".grammar-button").forEach(btn => {
    btn.addEventListener("click", () => {
      startGame(btn.dataset.set);
    });
  });

  // NICKNAME INPUT saves to variable
  nicknameInput.addEventListener("change", () => {
    userName = nicknameInput.value.trim();
    loadUserProgress(userName);
  });

  // LOAD USER PROGRESS ON NICKNAME ENTER
  function loadUserProgress(name) {
    if (!name) return;
    const saved = JSON.parse(localStorage.getItem(storageKey(name)));
    if (saved) {
      score = saved.score || 0;
      streak = saved.streak || 0;
      updateScoreDisplay();
      missionTracker.textContent = `Current streak: ${streak}`;
    } else {
      score = 0;
      streak = 0;
      updateScoreDisplay();
      missionTracker.textContent = "";
    }
  }

  // CLEAR PROGRESS BUTTON handled above

  // INIT
  loadLeaderboard();

  // Preload voices for speech synthesis
  window.speechSynthesis.onvoiceschanged = () => {};

</script>
</body>
</html>
